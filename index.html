const readButton = document.getElementById("readButton");
const readLog = document.getElementById("readLog");

readButton.addEventListener("click", async () => {
  try{
    // Web NFC 対応ブラウザでなければエラーを表示
    if(!("NDEFReader" in window)){
      readLog.textContent = "このブラウザはWeb NFCに対応していません。";
      return;
    }
    
    // NFCリーダーインスタンスを作成
    const ndef = new NDEFReader();
    
    // スキャンを開始
    await ndef.scan();
    readLog.textContent = "NFCカードをスキャン中です...カードを近づけてください。";
    
    // メッセージが読み取られた時の処理
    ndef.addEventListener("reading", (event) => {
      const { serialNumber, message } = event;
      readLog.textContent = `カードが読み取られました\nシリアル番号: ${serialNumber}`;
      
      // メッセージ内のレコードを処理
      for(const record of message.records){
        switch(record.recordType){
          case "text":
            // テキストデータの読み取り
            record.data = record.data || "";
            const textDecoder = new TextDecoder(record.encoding || "utf-8");
            const textContent = textDecoder.decode(record.data);
            readLog.textContent += `\nテキスト:${textContent}`;
            break;
          case "url":
            // URLデータの読み取り
            const urlContent = new TextDecoder("utf-8").decode(record.data);
            readLog.textContent += `\nURL:${urlContent}`;
            break;
          default:
            readLog.textContent += `\n未対応のデータタイプ:${record.recordType}`;
        }
      }
    });
    
    // エラー処理
    ndef.addEventListener("readingerror", () => {
      readLog.textContent = "NFCデータの読み取りに失敗しました。もう一度試してください。";
    });
    
  } catch (error) {
    console.error("エラーが発生しました:", error);
    readLog.textContent = `エラー: ${error.message}`;
  }
});